let input: string;

input = `
#.###########################################################################################################################################
#...#...#...###...###...#...#...#...#...###...#...#####.....#.............#.....#...#...###.......#...#.....#####...#...#####...#...###...###
###.#.#.#.#.###.#.###.#.#.#.#.#.#.#.#.#.###.#.#.#.#####.###.#.###########.#.###.#.#.#.#.###.#####.#.#.#.###.#####.#.#.#.#####.#.#.#.###.#.###
###.#.#.#.#...#.#...#.#.#.#.#.#.#.#.#.#.#...#...#.###...#...#.....#.......#...#...#.#.#.#...#.....#.#.#...#.#.....#...#.......#...#.#...#...#
###.#.#v#.###.#.###.#.#.#.#.#.#.#.#.#.#.#.#######.###.###.#######.#.#########.#####.#.#.#.###.#####.#.###.#.#.#####################.#.#####.#
###...#.>.#...#.#...#.#.#.#.#.#.#.#.#.#.#.......#...#...#.>.>.###.#.#...#...#.#.....#.#.#...#.#####.#.#...#.#...#...#...#.........#.#.#.....#
#######v###.###.#.###.#.#.#.#.#.#.#.#.#.#######.###.###.###v#.###.#.#.#.#.#.#.#.#####.#.###.#.#####.#.#.###.###.#.#.#.#.#.#######.#.#.#.#####
#...#...###.....#...#.#.#.#.#.#.#.#.#.#.#.....#...#.#...#...#.....#...#.#.#.#.#.#.....#.>.>.#...#...#.#...#.....#.#...#...#.....#...#.#.#...#
#.#.#.#############.#.#.#.#.#.#.#.#.#.#.#.###.###.#.#.###.#############.#.#.#.#.#.#######v#####.#.###.###.#######.#########.###.#####.#.#.#.#
#.#...#...###.......#.#.#.#.#.#.#.#.#.#.#...#.#...#...###...#...#...#...#.#...#...###...#.###...#...#.###.......#.#...#...#.#...#...#.#.#.#.#
#.#####.#.###.#######.#.#.#.#.#.#.#.#.#.###.#.#.###########.#.#.#.#.#.###.###########.#.#.###.#####.#.#########.#.#.#.#.#.#.#.###.#.#.#.#.#.#
#...#...#...#.#.....#.#.#.#.#.#.#.#.#.#.#...#.#...........#.#.#...#.#...#.#.........#.#.#...#.#...#.#...#...>.>.#...#...#.#.#...#.#.#.#.#.#.#
###.#.#####.#.#.###.#.#.#.#.#.#.#.#.#.#.#.###.###########.#.#.#####.###.#.#.#######.#.#.###.#.#.#.#.###.#.###v###########.#.###.#.#.#.#.#.#.#
###.#.#.....#.#.#...#.#.#.#.#.#.#.#.#.#.#...#.#...#.....#.#.#.#.....###...#.......#.#.#.#...#.#.#.#...#...#...#.........#.#.#...#.#.#.#.#.#.#
###.#.#.#####.#.#.###.#.#.#.#.#.#.#.#.#.###.#.#.#.#.###.#.#.#.#.#################.#.#.#.#.###.#.#.###.#####.###.#######.#.#.#.###.#.#.#.#.#.#
###...#.....#.#.#...#.#...#.#.#.#.#.#.#.>.>.#.#.#.#...#...#...#...........#.......#...#...#...#.#.#...#...#...#...#...#...#.#.#...#.#.#.#.#.#
###########.#.#.###.#.#####.#.#.#.#.#.###v###.#.#.###.###################.#.###############.###.#.#.###.#.###.###.#.#.#####.#.#.###.#.#.#.#.#
#...........#...#...#.....#.#.#...#...#...###.#.#.#...#...................#.............#...#...#.#...#.#.....###.#.#.....#.#.#.#...#.#...#.#
#.###############.#######.#.#.#########.#####.#.#.#.###.###############################.#.###.###.###.#.#########.#.#####.#.#.#.#.###.#####.#
#...............#...#...#.#...###...#...#...#...#...###...................#.............#.....###.....#.........#.#...#...#.#.#.#...#.#.....#
###############.###.#.#.#.#######.#.#.###.#.#############################.#.###################################.#.###.#.###.#.#.###.#.#.#####
#...............#...#.#...###.....#...###.#.###...#####...#...........#...#.#.......#...#.......###...#...#...#.#.#...#...#.#.#.#...#.#.....#
#.###############.###.#######.###########.#.###.#.#####.#.#.#########.#.###.#.#####.#.#.#.#####.###.#.#.#.#.#.#.#.#.#####.#.#.#.#.###.#####.#
#.......#.......#...#...#.....#.......###.#.#...#...#...#.#.........#...###...#.....#.#.#.....#.#...#.#.#...#...#...#.....#.#.#.#...#.#.....#
#######.#.#####.###.###.#.#####.#####.###.#.#.#####.#.###.#########.###########.#####.#.#####.#.#.###.#.#############.#####.#.#.###.#.#.#####
#.......#.#.....###.#...#...#...#.....#...#.#.....#.#.#...#####...#.......#...#.....#.#.#...#.#.#.#...#.........#...#...#...#...###...#.....#
#.#######.#.#######.#.#####.#.###.#####.###.#####.#.#.#.#######.#.#######.#.#.#####.#.#.#.#.#.#.#.#.###########.#.#.###.#.#################.#
#.#...#...#...#...#...#...#...#...###...#...#.....#.#.#.....#...#.........#.#.###...#.#.#.#.#.#.#.#.#...###.....#.#.###...###.........###...#
#.#.#.#.#####v#.#.#####.#.#####.#####.###.###.#####.#.#####.#.#############.#.###.###.#.#.#.#.#.#.#.#.#.###v#####.#.#########.#######.###.###
#...#.#.#...#.>.#...#...#.#...#.....#.#...###.....#...#.....#...#.........#.#.#...###.#.#.#.#.#.#.#...#...>.>.###.#.#...#...#.......#.....###
#####.#.#.#.#v#####.#.###.#.#.#####.#.#.#########.#####.#######.#.#######.#.#.#.#####.#.#.#.#.#.#.#########v#.###.#.#.#.#.#.#######.#########
#...#...#.#...#.....#...#.#.#.......#.#.#...#...#...#...###...#.#.#.......#.#.#...#...#...#.#.#...#.........#...#.#.#.#.#.#.#...###.........#
#.#.#####.#####.#######.#.#.#########.#.#.#.#.#.###.#.#####.#.#v#.#.#######.#.###.#.#######.#.#####.###########.#.#.#.#.#.#.#.#.###########.#
#.#.......#...#...#####.#.#.......#...#.#.#.#.#...#.#...#...#.>.>.#...#...#.#.###.#.......#.#...###...#.......#.#.#.#.#.#.#...#...#.........#
#.#########.#.###.#####.#.#######v#.###.#.#.#.###.#.###.#.#####v#####.#.#.#.#.###v#######.#.###.#####.#.#####.#.#.#.#.#.#.#######.#.#########
#.#.......#.#...#...#...#.......>.>.###...#...#...#...#...###...#...#...#.#.#...>.>.......#...#.#...#...#...#.#.#.#.#.#...#.......#.........#
#.#.#####.#.###.###.#.###########v#############.#####.#######.###.#.#####.#.#####v###########.#.#.#.#####.#.#.#.#.#.#.#####.###############.#
#...#...#.#.#...###...#...........###.......###.#.....#.......###.#.......#...###.........###...#.#.......#.#.#.#.#...#.....#...#...........#
#####.#.#.#.#.#########.#############.#####.###.#.#####.#########.###########.###########.#######.#########.#.#.#.#####.#####.#.#.###########
#...#.#.#...#.......###...............#.....#...#.#...#.........#.....#...#...#...........#...###.......###...#...#.....#...#.#.#.........###
#.#.#.#.###########.###################.#####.###.#.#.#########.#####.#.#.#.###.###########.#.#########.###########.#####.#.#.#.#########v###
#.#...#.............#...#...#.....#...#...###...#.#.#...........#...#...#...###.........#...#.#.......#.......#.....#...#.#.#.#...#.....>.###
#.###################.#.#.#.#.###.#.#.###.#####.#.#.#############.#.###################.#.###.#.#####.#######.#.#####.#.#.#.#.###.#.#####v###
#.#.....#...#...#.....#...#.#...#...#...#.....#.#.#...#...#.......#...#.....###...#...#.#...#.#.#...#.........#.....#.#.#.#.#.#...#.#.....###
#.#.###.#.#.#.#.#.#########.###.#######.#####.#.#.###.#.#.#.#########.#.###.###.#.#.#.#.###.#.#.#.#.###############.#.#.#.#.#.#.###.#.#######
#.#.#...#.#...#...#.........###.......#...#...#...###...#...#...#...#.#...#.....#...#...#...#.#...#.#.......#.......#.#.#.#...#...#.#.......#
#.#.#.###.#########.#################.###.#.#################.#.#.#.#.###.###############.###.#####.#.#####.#.#######.#.#.#######.#.#######.#
#.#.#...#.#.........#...#...#.........###...#...###...###.....#...#...#...#...........###...#.#.....#.#.....#.......#.#...###...#.#.#.......#
#.#.###.#.#.#########.#.#.#.#.###############.#.###.#.###.#############.###.#########.#####.#.#.#####.#.###########.#.#######.#.#.#.#.#######
#.#...#...#...........#...#.#.........#.....#.#.#...#.....###...#...###.....#...#.....#...#.#.#...#...#.#...#.....#.#.#.....#.#.#...#.......#
#.###.#####################.#########.#.###.#.#.#.###########.#.#.#.#########.#.#.#####.#.#.#.###.#.###.#.#.#.###.#.#.#.###.#.#.###########.#
#.....###...................#.........#...#...#.#.........#...#...#...#...#...#...#...#.#...#.###...###...#...#...#...#...#.#.#.###...#.....#
#########.###################.###########.#####.#########.#.#########.#.#.#.#######.#.#.#####.#################.#########.#.#.#.###.#.#.#####
#.....#...#...#.....#...#...#...#...#...#.....#.#...#...#.#.#...#.....#.#.#...###...#.#...#...#...#...#.........#...#.....#.#.#.#...#.#.....#
#.###.#.###.#.#.###.#.#.#.#.###.#.#.#.#.#####.#.#.#.#.#.#v#.#.#.#.#####.#.###.###.###.###.#.###.#.#.#.#v#########.#.#.#####.#.#.#.###.#####.#
#...#.#.....#...#...#.#.#.#.....#.#.#.#.#...#.#.#.#...#.>.>.#.#...#.....#.###...#...#...#.#...#.#.#.#.>.>...#...#.#.#.....#.#.#.#...#.###...#
###.#.###########v###.#.#.#######.#.#.#.#.#.#.#.#.#######v###.#####.#####.#####.###.###.#.###.#.#.#.###v###.#.#.#.#.#####.#.#.#.###.#.###v###
#...#...........#.>.#.#.#.......#.#.#.#.#.#...#.#.....#...###...###.....#.#.....###...#...#...#.#.#.###...#.#.#.#.#...#...#.#.#.#...#.#.>.###
#.#############.#v#.#.#.#######v#.#.#.#.#.#####.#####.#.#######.#######.#.#v#########.#####.###.#.#.#####.#.#.#.#.###.#.###.#.#.#.###.#.#v###
#.............#.#.#.#.#.#...#.>.>.#...#.#.###...#.....#.....###...#...#.#.>.>.#...#...#.....#...#.#.#.....#...#.#.#...#.#...#.#.#.###.#.#...#
#############.#.#.#.#.#.#.#.#.#v#######.#.###.###.#########.#####.#.#.#.###v#.#.#.#.###.#####.###.#.#.#########.#.#.###.#.###.#.#.###.#.###.#
###...#.....#.#...#.#.#.#.#.#.#.###.....#...#...#...#.......#.....#.#.#.#...#...#...###.....#...#...#.....#...#...#.#...#...#.#.#...#...#...#
###.#.#.###.#.#####.#.#.#.#.#.#.###.#######.###.###.#.#######.#####.#.#.#.#################.###.#########.#.#.#####.#.#####.#.#.###.#####.###
#...#...#...#.....#...#...#.#.#...#.........###.....#.......#.#...#.#.#.#.#...#####...#...#.....###...###...#.....#...#...#.#.#.#...###...###
#.#######.#######.#########.#.###.#########################.#.#.#.#.#.#.#.#.#.#####.#.#.#.#########.#.###########.#####.#.#.#.#.#.#####.#####
#.......#.#.....#.....#.....#...#...###.....#.....#.........#...#.#.#.#.#.#.#...###.#...#.....#.....#.............#.....#.#...#...#...#.....#
#######.#.#.###.#####.#.#######.###.###.###.#.###.#.#############.#.#.#.#.#.###.###.#########.#.###################.#####.#########.#.#####.#
#.......#.#...#.#...#.#.....#...###...#.#...#.#...#...........#...#.#...#...###.....#...#.....#.....#.....###.......#...#...#...#...#.......#
#.#######.###.#.#.#.#.#####.#.#######.#.#.###.#.#############.#.###.#################.#.#.#########.#.###.###.#######.#.###.#.#.#.###########
#.......#.....#...#...#.....#.#...#...#.#.....#...#...........#.....###...#...........#...#.....###...###...#.#.......#.....#.#.#...........#
#######.###############.#####.#.#.#.###.#########.#.###################.#.#.###############.###.###########.#.#.#############.#.###########.#
###...#...............#.#...#...#.#...#.#.........#.....................#.#.....#.........#...#.......#...#...#...#.........#.#.....#.......#
###.#.###############.#.#.#.#####.###.#.#.###############################.#####.#.#######.###.#######.#.#.#######.#.#######.#.#####.#.#######
#...#.................#...#...#...###...#.......#...#.................#...#...#.#.#.......#...#.......#.#.#.......#...#.....#.....#...#...###
#.###########################.#.###############.#.#.#.###############.#.###.#.#.#.#.#######.###.#######.#.#.#########.#.#########.#####.#.###
#.......................###...#.#.....#...#...#.#.#.#.......#...#...#...###.#.#...#.#.....#...#.#...#...#.#.......#...#...#.....#.......#...#
#######################.###.###.#.###.#.#.#.#.#.#.#.#######.#.#.#.#.#######.#.#####.#.###.###.#.#.#.#.###.#######.#.#####.#.###.###########.#
#.......................#...#...#...#...#...#.#...#.#.......#.#.#.#...#...#.#.#...#.#.#...###.#.#.#.#...#.###.....#.#.....#.#...#...#...#...#
#.#######################.###.#####.#########.#####.#.#######.#.#.###.#.#.#.#.#.#.#.#.#.#####.#.#.#.###.#.###v#####.#.#####.#.###.#.#.#.#v###
#...............#.....###.....#...#.........#.......#.......#.#.#...#...#.#.#.#.#.#...#.###...#.#.#.#...#...>.>.#...#...#...#.#...#.#.#.>.###
###############.#.###.#########.#.#########.###############.#.#.###.#####.#.#.#.#.#####.###.###.#.#.#.#######v#.#.#####.#.###.#.###.#.###v###
###...#...#.....#.#...#...#.....#.#.....#...###...###...#...#.#.###.#.....#.#.#.#.#...#.#...#...#.#.#...#.....#.#.#.....#...#...###...###...#
###.#.#.#.#.#####.#.###.#.#.#####.#.###.#.#####.#.###.#.#v###.#.###.#.#####.#.#.#.#.#.#v#.###.###.#.###.#.#####.#.#.#######.###############.#
#...#...#...#.....#...#.#...#.....#...#.#...#...#.#...#.>.>...#.#...#.#...#.#.#.#.#.#.>.>.###.....#.....#.....#.#.#.........#...#...#.....#.#
#.###########.#######.#.#####.#######.#.###.#.###.#.#####v#####.#.###.#.#.#.#.#.#.#.###v#####################.#.#.###########.#.#.#.#.###.#.#
#...#...#...#.#.......#.....#.#.....#.#.###...#...#...#...#...#...#...#.#...#.#.#.#...#.......###...#.....#...#.#.#.........#.#...#.#...#.#.#
###.#.#.#.#v#.#.###########.#.#.###.#.#.#######.#####.#.###.#.#####.###.#####.#.#.###.#######.###.#.#.###.#.###.#.#.#######.#.#####.###.#.#.#
#...#.#...#.>.#.#...###...#.#.#...#.#.#.###.....#.....#.....#.....#.....#...#.#.#.....#...#...#...#...###...###...#...#...#...#...#.#...#.#.#
#.###.#####v###.#.#.###.#.#.#.###.#.#.#.###v#####.###############.#######.#.#.#.#######.#.#.###.#####################.#.#.#####.#.#.#.###.#.#
#.....#...#.#...#.#...#.#.#.#.#...#.#.#...>.>...#...###...#...#...#.......#...#.###...#.#...###...................###...#.#.....#.#...###.#.#
#######.#.#.#.###.###.#.#.#.#.#.###.#.#####v###.###.###.#.#.#.#.###.###########.###.#.#.#########################.#######.#.#####.#######.#.#
#.......#...#.....###.#.#.#.#.#...#.#.#.....###.....#...#...#...###.......#...#.#...#...#...###...................#...###...#...#.......#.#.#
#.###################.#.#.#.#.###.#.#.#.#############.###################.#.#.#.#.#######.#.###.###################.#.#######.#.#######.#.#.#
#...........#...#...#.#.#...#.#...#...#.........#...#.........#...###...#...#...#...#.....#...#...........#.....#...#...#...#.#.....#...#.#.#
###########.#.#.#.#.#.#.#####.#.###############.#.#.#########.#.#.###.#.###########.#.#######.###########.#.###.#.#####.#.#.#.#####.#.###.#.#
#...........#.#...#.#.#...#...#...#...#.........#.#.#.......#.#.#.#...#.###.....###...#.....#.#...........#.#...#.....#...#.#.....#...###...#
#.###########.#####.#.###.#.#####.#.#.#.#########.#.#.#####.#.#.#.#.###.###.###.#######.###.#.#.###########.#.#######.#####.#####.###########
#.#.........#.###...#.....#.......#.#.#.......#...#...#...#...#.#.#...#.#...#...#.......###...#.#.....#.....#.#...###...#...#.....#.....#...#
#.#.#######.#.###.#################.#.#######.#.#######.#.#####.#.###.#.#.###.###.#############.#.###.#.#####.#.#.#####.#.###.#####.###.#.#.#
#.#.#.......#.#...#.....#...#.....#.#.###.....#...#.....#...###.#.#...#.#...#.###.........#...#.#.#...#.#.....#.#.#...#.#.###.....#...#.#.#.#
#.#.#.#######.#.###.###.#.#.#.###.#.#.###v#######.#.#######.###.#.#.###.###.#.###########.#.#.#.#.#.###.#.#####.#.#.#.#.#.#######.###.#.#.#.#
#...#.......#.#.....#...#.#.#...#...#...>.>.#...#...#.......#...#.#.#...#...#.#.....#.....#.#.#.#.#...#.#.#...#.#.#.#.#.#.#...#...#...#.#.#.#
###########.#.#######.###.#.###.#########v#.#.#.#####.#######.###.#.#.###.###.#.###.#.#####.#.#.#.###.#.#.#.#.#.#.#.#.#.#.#.#.#v###.###.#.#.#
#...###...#...###...#...#.#...#...###.....#.#.#...#...###...#...#.#.#.###...#.#...#.#...###.#.#...#...#.#.#.#.#.#.#.#.#.#.#.#.>.###...#.#.#.#
#.#.###.#.#######.#.###.#.###.###.###.#####.#.###.#.#####.#.###.#.#.#.#####.#.###.#.###v###.#.#####v###.#.#.#.#.#.#.#.#.#.#.###v#####.#.#.#.#
#.#.....#.........#...#.#...#.....#...#...#...#...#...#...#...#.#.#.#...#...#...#.#...>.>...#.#...>.>...#...#...#.#.#.#.#.#.#...###...#...#.#
#.###################.#.###.#######.###.#.#####.#####v#.#####.#.#.#.###.#.#####.#.#####v#####.#.###v#############.#.#.#.#.#.#.#####.#######.#
#.....#.....#.......#...###.......#.....#.....#...#.>.>.#####...#...#...#...#...#.#.....#.....#...#...###.......#...#...#.#.#.....#.#.......#
#####.#.###.#.#####.#############.###########.###.#.#v###############.#####.#.###.#.#####.#######.###.###.#####.#########.#.#####.#.#.#######
#...#...###.#.###...###...#.......#...........###.#.#.#...###...#...#.......#.#...#.....#.#.....#...#...#.#.....#.........#.#...#.#.#...#...#
#.#.#######.#.###v#####.#.#.#######.#############.#.#.#.#.###.#.#.#.#########.#.#######.#.#.###.###.###.#.#.#####.#########.#.#.#.#.###.#.#.#
#.#...#...#...###.>...#.#.#...#...#.........#.....#.#.#.#.....#...#.........#.#.#...#...#...###...#.#...#.#.....#.........#.#.#...#.#...#.#.#
#.###.#.#.#######v###.#.#.###.#.#.#########.#.#####.#.#.###################.#.#.#.#.#.###########.#.#.###.#####.#########.#.#.#####.#.###.#.#
#.#...#.#.#...###...#.#.#.#...#.#.....#...#.#...#...#...#...............#...#...#.#.#.....#...###...#...#.#.....#.....#...#.#.....#.#.....#.#
#.#.###.#.#.#.#####.#.#.#.#.###.#####.#.#.#.###.#.#######.#############.#.#######.#.#####.#.#.#########.#.#.#####.###.#.###.#####.#.#######.#
#.#.....#.#.#.#.....#...#.#.###.#...#...#...###...#...###.............#...#...#...#...#...#.#.#.....###...#...#...#...#...#.#...#.#.#.......#
#.#######.#.#.#.#########.#.###.#.#.###############.#.###############.#####.#.#.#####.#.###.#.#.###.#########.#.###.#####.#.#.#.#.#.#.#######
#...#...#.#.#.#.......###...###...#.......###...#...#.#.....###.......###...#.#.#...#.#.###.#...#...#...#...#...#...#####...#.#.#...#.....###
###.#.#.#.#.#.#######.###################.###.#.#.###.#.###.###.#########.###.#.#.#.#.#.###.#####.###.#.#.#.#####.###########.#.#########.###
#...#.#.#...#.......#.....#...............#...#...#...#...#.#...#...#...#.#...#...#.#...#...#.....#...#.#.#.......#...#...#...#...#.....#...#
#.###.#.###########.#####.#.###############.#######.#####.#.#.###.#.#.#.#.#.#######.#####.###.#####.###.#.#########.#.#.#.#.#####.#.###.###.#
#.#...#...........#.......#...............#.......#.....#.#.#.....#.#.#.#.#.#.....#.#...#.#...#...#...#.#.........#.#.#.#.#...#...#...#.....#
#.#.#############.#######################.#######.#####.#.#.#######.#.#.#.#.#.###.#.#.#.#.#.###.#.###.#.#########v#.#.#.#.###.#.#####.#######
#.#.#...........#...#.....#...............#.....#.#.....#.#.###.....#.#.#.#.#.#...#.#.#.#.#.#...#.#...#...#...#.>.>.#.#.#.#...#.....#.......#
#.#.#.#########.###.#.###.#.###############.###.#.#.#####.#.###v#####.#.#.#.#.#.###v#.#.#.#.#.###.#.#####.#.#.#.#####.#.#.#.#######.#######.#
#.#.#.........#.....#.#...#...............#...#.#.#.#.....#.#.>.>.#...#.#.#...#.#.>.>.#.#.#.#.#...#.#.....#.#.#.#####.#.#.#...#.....#.......#
#.#.#########.#######.#.#################.###.#.#.#.#.#####.#.###.#.###.#.#####.#.#####.#.#.#.#.###.#.#####.#.#.#####.#.#.###.#.#####.#######
#...#.........#.......#...#...###...###...#...#...#.#.....#.#.#...#...#.#.#.....#.#...#...#...#...#.#.....#.#...#.....#.#.....#...###.......#
#####.#########.#########.#.#.###.#.###.###.#######.#####.#.#.#.#####.#.#.#.#####.#.#.###########.#.#####.#.#####.#####.#########.#########.#
#.....#.........###.......#.#.....#.....###.......#...#...#.#.#...#...#...#.....#...#...#...###...#.....#.#.....#.....#.###...###...#...#...#
#.#####.###########.#######.#####################.###.#.###.#.###.#.###########.#######.#.#.###.#######.#.#####.#####.#.###.#.#####.#.#.#v###
#.......#.........#.#...###.............###...#...#...#...#...#...#.......#.....#.....#...#...#.....#...#.......#.....#...#.#.......#.#.>.###
#########.#######.#.#.#.###############v###.#.#.###.#####.#####.#########.#.#####.###.#######.#####.#.###########.#######.#.#########.###v###
#.......#...#...#...#.#...#.....#...#.>.>.#.#.#...#.#...#.....#...#...#...#...#...###.#...#...###...#.#...........#...#...#...#...#...#...###
#.#####.###.#.#.#####.###.#.###.#.#.#.###.#.#.###.#.#.#.#####.###.#.#.#.#####.#.#####.#.#.#.#####.###.#.###########.#.#.#####.#.#.#.###.#####
#.....#.....#.#.#...#.###.#...#.#.#.#.###.#.#.#...#.#.#...#...#...#.#.#.###...#.....#.#.#.#.....#.#...#.#.....#...#.#.#.#.....#.#.#.###.....#
#####.#######.#.#.#.#.###.###.#.#.#.#.###.#.#.#.###.#.###.#.###.###.#.#.###.#######.#.#.#.#####.#.#.###.#.###.#.#.#.#.#.#.#####.#.#.#######.#
#.....#.....#.#.#.#.#.#...#...#.#.#.#...#.#.#.#.#...#...#.#...#...#.#.#.#...#...#...#.#.#.#...#.#.#...#.#.#...#.#.#.#.#.#...#...#.#.#.......#
#.#####.###.#.#.#.#.#.#.###.###.#.#.###.#.#.#.#.#.#####.#.###.###.#.#.#.#.###.#.#.###.#.#.#.#.#.#.###.#.#.#.###.#.#.#.#.###.#.###.#.#.#######
#.......###...#...#...#.....###...#.....#...#...#.......#.....###...#...#.....#...###...#...#...#.....#...#.....#...#...###...###...#.......#
###########################################################################################################################################.#
`;

// input = `
// #.#####################
// #.......#########...###
// #######.#########.#.###
// ###.....#.>.>.###.#.###
// ###v#####.#v#.###.#.###
// ###.>...#.#.#.....#...#
// ###v###.#.#.#########.#
// ###...#.#.#.......#...#
// #####.#.#.#######.#.###
// #.....#.#.#.......#...#
// #.#####.#.#.#########v#
// #.#...#...#...###...>.#
// #.#.#v#######v###.###v#
// #...#.>.#...>.>.#.###.#
// #####v#.#.###v#.#.###.#
// #.....#...#...#.#.#...#
// #.#########.###.#.#.###
// #...###...#...#...#.###
// ###.###.#.###v#####v###
// #...#...#.#.>.>.#.>.###
// #.###.###.#.###.#.#v###
// #.....###...###...#...#
// #####################.#
// `;

input = `
#.#####
#.....#
#.....#
#.....#
#####.#
`;

input = `
#.########
#....#####
#.##.#####
#........#
##.#####.#
##.......#
########.#
`;

const board: string[][] = input
  .trim()
  .split("\n")
  .map((line) => line.split(""));

function inBounds(r: number, c: number) {
  return r >= 0 && r < board.length && c >= 0 && c < board[0].length;
}

let output: HTMLElement | null = null;
function visualizePath(path: Set<string>, cache: Map<string, number | null>) {
  if (output) output.remove();
  output = document.createElement("div");
  output.style.display = "flex";
  output.style.flexDirection = "column";

  const cellDimensions = 90;

  const columnNumbers = document.createElement("div");
  for (let c = 0; c < board[0].length; c++) {
    // Add column number
    const cell = document.createElement("div");
    cell.style.width = `${cellDimensions}px`;
    cell.style.height = `${cellDimensions}px`;
    cell.style.border = "1px solid #333";
    cell.style.backgroundColor = "white";
    cell.style.textAlign = "center";
    cell.innerText = `${c}`;
    columnNumbers.appendChild(cell);
  }
  columnNumbers.style.display = "flex";
  output.appendChild(columnNumbers);

  for (let r = 0; r < board.length; r++) {
    const row = document.createElement("div");
    row.style.display = "flex";
    for (let c = 0; c < board[0].length; c++) {
      const cell = document.createElement("div");
      cell.style.width = `${cellDimensions}px`;
      cell.style.height = `${cellDimensions}px`;
      cell.style.border = "1px solid #333";
      cell.style.backgroundColor = board[r][c] === "#" ? "#333" : "white";
      if (path.has(`${r},${c}`)) {
        cell.style.backgroundColor = "crimson";
      }
      // Find all matching cache keys
      const values = [...cache.entries()]
        .map(([key, value]) => {
          const [r2, c2, direction] = key.split(",");
          return { r: Number(r2), c: Number(c2), direction, value };
        })
        .filter((key) => key.r === r && key.c === c);
      cell.style.border = "4px solid green";
      cell.innerText = values
        .map((value) => `${value.direction}: ${value.value || null}`)
        .join("\n");
      cell.style.display = "flex";
      cell.style.textAlign = "center";
      cell.style.justifyContent = "center";
      cell.style.alignItems = "center";
      row.appendChild(cell);
    }
    output.appendChild(row);
  }
  document.body.appendChild(output);
}

const sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));

type Direction = "^" | ">" | "v" | "<";

class PathNode {
  r: number;
  c: number;
  path: Set<string>;
  prevDirection: Direction | undefined;

  constructor(
    r: number,
    c: number,
    path: Set<string>,
    prevDirection: Direction | undefined
  ) {
    this.r = r;
    this.c = c;
    this.path = path;
    this.prevDirection = prevDirection;
  }

  get positionKey(): string {
    return `${this.r},${this.c}`;
  }
}

async function main() {
  const cache = new Map<string, number | null>();

  const recurse = async (node: PathNode): Promise<number | null> => {
    const { r, c } = node;

    // visualizePath(node.path, cache);
    // await sleep(2);

    const cacheKey = `${r},${c},${node.prevDirection}`;
    let ret = cache.get(cacheKey);
    if (ret === undefined) {
      if (r === board.length - 1) {
        console.log("Found path", node.path.size);
        visualizePath(node.path, cache);
        await sleep(2);
        return 1;
      }

      const newPath = new Set(node.path);
      newPath.add(node.positionKey);

      const up = new PathNode(r - 1, c, newPath, "^");
      const down = new PathNode(r + 1, c, newPath, "v");
      const left = new PathNode(r, c - 1, newPath, "<");
      const right = new PathNode(r, c + 1, newPath, ">");
      const options = [up, down, left, right].filter((x) => {
        // Avoid us going back the way we came
        if (node.path.has(x.positionKey)) {
          return false;
        }

        if (!inBounds(x.r, x.c)) {
          return false;
        }

        // Wall
        if (board[x.r][x.c] === "#") {
          return false;
        }

        return true;
      });

      if (options.length === 0) ret = null;
      else {
        ret = 0;
        let subAnswer0 = await recurse(options[0]);
        if (typeof subAnswer0 === "number") ret = Math.max(subAnswer0 + 1, ret);
        let subAnswer1 = options[1] ? await recurse(options[1]) : null;
        if (typeof subAnswer1 === "number") ret = Math.max(subAnswer1 + 1, ret);
        let subAnswer2 = options[2] ? await recurse(options[2]) : null;
        if (typeof subAnswer2 === "number") ret = Math.max(subAnswer2 + 1, ret);
        ret = ret || null;
      }
    }
    if (ret === undefined) throw new Error("Ret is undefined");
    cache.set(cacheKey, ret);
    return ret;
  };

  const startNode = new PathNode(0, 1, new Set<string>(), undefined);
  console.log("Result", (await recurse(startNode))! - 1);
  visualizePath(startNode.path, cache);
}
main();
